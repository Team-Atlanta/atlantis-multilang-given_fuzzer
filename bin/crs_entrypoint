#!/bin/bash
# =============================================================================
# OSS-CRS Entrypoint
# =============================================================================
# Runner for OSS-CRS framework.
#
# Usage:
#   docker run crs-multilang-runner <harness_name>   # Run single harness
#   docker run crs-multilang-runner list             # List available harnesses
#   docker run crs-multilang-runner shell            # Interactive shell
# =============================================================================

set -e

MODE="${1:-run-harness}"
shift 2>/dev/null || true

# System tuning
sysctl -w fs.file-max=2097152 2>/dev/null || true
ulimit -c 0 2>/dev/null || true

# =============================================================================
# Environment setup
# =============================================================================
export SRC_DIR="${SRC_DIR:-/src}"
export OUT_DIR="${OUT_DIR:-/out}"
export OUT="${OUT:-$OUT_DIR}"
export OSS_CRS_ARTIFACTS_DIR="${OSS_CRS_ARTIFACTS_DIR:-/artifacts}"
export TARBALL_DIR="${OSS_CRS_ARTIFACTS_DIR}/tarballs"
# Read sanitizer from build metadata, fallback to env/default
if [ -z "${SANITIZER:-}" ] && [ -f "${TARBALL_DIR}/crs-sanitizer" ]; then
    SANITIZER=$(cat "${TARBALL_DIR}/crs-sanitizer")
fi
export SANITIZER="${SANITIZER:-address}"

# =============================================================================
# Helper functions
# =============================================================================
log() {
    echo "[CRS] $*"
}

error() {
    echo "[CRS] ERROR: $*" >&2
    exit 1
}

list_harnesses() {
    log "Available harnesses in $OUT_DIR:"
    if [ -f "$OUT_DIR/aixcc_conf.yaml" ]; then
        grep -A1 "name:" "$OUT_DIR/aixcc_conf.yaml" | grep -v "^--$" || true
    fi
    find "$OUT_DIR" -maxdepth 1 -type f -executable 2>/dev/null | while read f; do
        basename "$f"
    done
}

# =============================================================================
# RUN-HARNESS (OSS-CRS mode)
# =============================================================================
do_run_harness() {
    HARNESS="${1:-}"
    shift 2>/dev/null || true

    # Support --harness_name flag for OSS-CRS compatibility
    if [ "$HARNESS" = "--harness_name" ]; then
        HARNESS="${1:-}"
        shift 2>/dev/null || true
    fi

    if [ -z "$HARNESS" ]; then
        error "No harness specified. Usage: docker run <image> <harness_name>"
    fi

    log "=== OSS-CRS RUN ==="
    log "Harness: $HARNESS"
    log "CRS Name: ${CRS_NAME:-crs-multilang}"
    log "CRS Target: ${CRS_TARGET:-unknown}"

    # Validate input
    [ -d "$OUT_DIR" ] || error "No $OUT_DIR directory mounted"

    # Verify harness exists (with normalization for @ and case differences)
    if [ ! -x "$OUT_DIR/$HARNESS" ]; then
        if [ -x "$OUT_DIR/${HARNESS}_fuzzer" ]; then
            HARNESS="${HARNESS}_fuzzer"
        elif [ -f "$OUT_DIR/$HARNESS" ]; then
            chmod +x "$OUT_DIR/$HARNESS"
        else
            # Try to find binary by normalized name match:
            # OSS-Fuzz uses @ for options (e.g., harness@NO_OOM) which frameworks
            # may normalize to harness_no_oom. Find the actual binary name.
            HARNESS_LOWER=$(echo "$HARNESS" | tr '[:upper:]' '[:lower:]')
            FOUND=""
            for bin in "$OUT_DIR"/*; do
                [ -f "$bin" ] || continue
                BIN_NAME=$(basename "$bin")
                # Normalize: replace @ with _, lowercase
                BIN_NORMALIZED=$(echo "$BIN_NAME" | tr '@' '_' | tr '[:upper:]' '[:lower:]')
                if [ "$BIN_NORMALIZED" = "$HARNESS_LOWER" ]; then
                    FOUND="$BIN_NAME"
                    break
                fi
            done
            if [ -n "$FOUND" ]; then
                log "Resolved harness: $HARNESS -> $FOUND"
                HARNESS="$FOUND"
                [ -x "$OUT_DIR/$HARNESS" ] || chmod +x "$OUT_DIR/$HARNESS"
            else
                log "Warning: Harness binary not found at $OUT_DIR/$HARNESS"
            fi
        fi
    fi

    export TARGET_HARNESS="$HARNESS"
    export HARNESS_NAME="$HARNESS"
    export START_TIME="${START_TIME:-$(date +%s)}"

    if [ -f "$OUT_DIR/aixcc_conf.yaml" ]; then
        export AIXCC_CONFIG="$OUT_DIR/aixcc_conf.yaml"
    fi

    # Write /crs.config to filter to the requested harness only
    # (Config.load reads this JSON; target_harnesses=null means ALL harnesses)
    echo "{\"target_harnesses\": [\"$HARNESS\"]}" > /crs.config
    log "Config: /crs.config (target: $HARNESS)"

    # Create output directories
    mkdir -p "$OSS_CRS_ARTIFACTS_DIR/povs"
    mkdir -p "$OSS_CRS_ARTIFACTS_DIR/corpus"
    mkdir -p "$OSS_CRS_ARTIFACTS_DIR/crs-data"

    # Symlink coverage binaries (built by builder.Dockerfile into /out/coverage-out/)
    if [ -d "$OUT_DIR/coverage-out" ] && [ ! -e "/coverage-out" ]; then
        ln -s "$OUT_DIR/coverage-out" /coverage-out
        log "Coverage binary: /coverage-out (via $OUT_DIR/coverage-out)"
    fi

    # Restore OSS-Fuzz project files (project.yaml, .aixcc/, build.sh, etc.)
    mkdir -p /src
    if [ -f "$TARBALL_DIR/crs-project.tar.gz" ]; then
        tar xzf "$TARBALL_DIR/crs-project.tar.gz" -C /src/ 2>/dev/null || true
        log "Restored OSS-Fuzz project files from crs-project.tar.gz"
    fi

    # Restore source tree from builder tarball
    if [ -f "$TARBALL_DIR/crs-src.tar.gz" ]; then
        tar xzf "$TARBALL_DIR/crs-src.tar.gz" -C /src/ 2>/dev/null || true
        log "Restored source tree from crs-src.tar.gz"
    fi

    # Fallback if project.yaml still not found
    if [ ! -f "/src/project.yaml" ]; then
        log "WARNING: project.yaml not found, defaulting to language=c"
        echo "language: c" > /src/project.yaml
    fi

    # Handle ref.diff (OSS-CRS mounts at /ref.diff, libCRS expects /src/ref.diff)
    if [ -f "/ref.diff" ] && [ ! -f "/src/ref.diff" ]; then
        cp /ref.diff /src/ref.diff
    fi

    # Export for main.py compatibility
    export POV_DIR="$OSS_CRS_ARTIFACTS_DIR/povs"
    export CORPUS_DIR="$OSS_CRS_ARTIFACTS_DIR/corpus"
    export CRS_DATA_DIR="$OSS_CRS_ARTIFACTS_DIR/crs-data"
    export SEED_SHARE_DIR="${SEED_SHARE_DIR:-/seed_share_dir}"

    # Log mode info
    [ -f "/ref.diff" ] && log "Delta mode: /ref.diff"
    [ -d "/seed_share_dir" ] && log "Ensemble mode: /seed_share_dir"

    log "Output: $OSS_CRS_ARTIFACTS_DIR"
    log "Starting fuzzing..."

    # Run CRS
    main.py

    log "Run complete. Results:"
    log "  POVs: $(find $OSS_CRS_ARTIFACTS_DIR/povs -type f 2>/dev/null | wc -l) files"
    log "  Corpus: $(find $OSS_CRS_ARTIFACTS_DIR/corpus -type f 2>/dev/null | wc -l) files"
    log "  Coverage: $(find $OSS_CRS_ARTIFACTS_DIR/crs-data/coverage -type f 2>/dev/null | wc -l) files"
}

# =============================================================================
# LIST HARNESSES
# =============================================================================
do_list() {
    log "=== LIST HARNESSES ==="
    list_harnesses
}

# =============================================================================
# SHELL
# =============================================================================
do_shell() {
    log "Interactive shell"
    exec /bin/bash "$@"
}

# =============================================================================
# HELP
# =============================================================================
do_help() {
    cat << 'EOF'
OSS-CRS Runner

USAGE:
    docker run crs-multilang-runner <harness_name>   Run fuzzing for harness
    docker run crs-multilang-runner list             List available harnesses
    docker run crs-multilang-runner shell            Interactive shell
    docker run crs-multilang-runner help             Show this help

ENVIRONMENT (set by OSS-CRS framework):
    CRS_TARGET          Target project name
    CRS_NAME            CRS identifier
    FUZZING_LANGUAGE    Target language (c, c++, jvm)

INPUTS:
    /out/               Compiled fuzzers (from build phase)
    /artifacts/         Persistent artifacts directory
    /ref.diff           Diff file for delta mode (optional)
    /seed_share_dir/    Ensemble shared seeds (optional)

OUTPUTS:
    /artifacts/povs/{harness}/              POVs discovered
    /artifacts/corpus/{harness}/            Fuzzing corpus
    /artifacts/crs-data/coverage/{harness}/ Coverage data
EOF
}

# =============================================================================
# Main dispatch
# =============================================================================
case "$MODE" in
    run-harness)
        do_run_harness "$@"
        ;;
    list|ls)
        do_list "$@"
        ;;
    shell|bash|sh)
        do_shell "$@"
        ;;
    help|--help|-h)
        do_help
        ;;
    *)
        # Default: treat as harness name
        do_run_harness "$MODE" "$@"
        ;;
esac
