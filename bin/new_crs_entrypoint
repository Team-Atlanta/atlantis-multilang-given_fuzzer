#!/bin/bash

# =============================================================================
# Download build outputs
# =============================================================================
libCRS download-build-output uniafl/build /out
libCRS download-build-output uniafl/src /src
libCRS download-build-output uniafl/project /src/
libCRS download-build-output coverage/build /coverage-out || echo "[entrypoint] coverage/build not available, continuing without coverage"

# =============================================================================
# Register dirs
# =============================================================================

# Automatically submit povs/seeds in these directories to oss-crs-infra
libCRS register-submit-dir pov /povs 
libCRS register-submit-dir seed /seeds
libCRS register-submit-dir bug-candidate /bug-candidates

# Periodically fetch shared data from other CRSs (via framework exchange)
libCRS register-fetch-dir pov /shared-povs
libCRS register-fetch-dir seed /shared-seeds
libCRS register-fetch-dir bug-candidate /shared-bug-candidates

# =============================================================================
# One-time fetch: bootup data from crs-compose run flags
# =============================================================================

# Fetch diff for delta mode (--diff flag â†’ FETCH_DIR/diff/ref.diff)
mkdir -p /shared-diffs
libCRS fetch diff /shared-diffs || echo "[entrypoint] No diff available (full mode)"
if [ -f "/shared-diffs/ref.diff" ]; then
    cp /shared-diffs/ref.diff /src/ref.diff
    echo "[entrypoint] Delta mode: ref.diff available at /src/ref.diff"
fi

# =============================================================================
# Set env up for this CRS
# =============================================================================

export CRS_TARGET=$OSS_CRS_TARGET
echo "{\"target_harnesses\": [\"$OSS_CRS_TARGET_HARNESS\"]}" > /crs.config

mkdir -p "/crs-data"
export POV_DIR="/povs"
export CORPUS_DIR="/corpus"
export CRS_DATA_DIR="/crs-data"
export SEED_SHARE_DIR="/shared-seeds"
export BUG_CANDIDATE_DIR="/bug-candidates"

main.py